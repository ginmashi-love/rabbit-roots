<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>rabbit-roots | å€‹ä½“ãƒšãƒ¼ã‚¸ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—Aï¼‰</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2f;
      --card2:#0f1930;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --muted2:rgba(234,240,255,.55);
      --accent:#ff6aa2;
      --sky:#53b7ff;
      --mint:#35d6a7;
      --warn:#ffcc4a;
      --bad:#ff5d73;
      --radius:18px;
      --tap:44px;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(83,183,255,.35);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(255,106,162,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(83,183,255,.16), transparent 55%),
        radial-gradient(900px 700px at 45% 95%, rgba(53,214,167,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 14px 14px 44px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 12px 12px;
      border: 1px solid var(--line);
      background: rgba(16,26,47,.65);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 10px;
      z-index: 10;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .logo{
      width:38px; height:38px; border-radius: 14px;
      background:
        radial-gradient(70px 55px at 25% 25%, rgba(255,106,162,.35), transparent 55%),
        radial-gradient(70px 55px at 75% 35%, rgba(83,183,255,.30), transparent 55%),
        rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      font-weight: 1000;
    }
    .brandText{ min-width:0; }
    .brandText b{ display:block; font-size: 13px; letter-spacing:.2px; }
    .brandText span{ display:block; font-size: 11px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 56vw; }
    .btn{
      min-height: var(--tap);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      display:inline-flex; align-items:center; gap:8px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn:focus{ outline:none; box-shadow: var(--shadow), var(--focus); }
    .btnSky{ border-color: rgba(83,183,255,.30); }
    .btnMint{ border-color: rgba(53,214,167,.30); }
    .btnGhost{ box-shadow:none; background: rgba(255,255,255,.04); }
    .row{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 860px){ .row{ grid-template-columns:1fr; } }

    .card{
      border: 1px solid var(--line);
      background: rgba(16,26,47,.62);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .pad{ padding: 14px; }
    .h2{
      margin:0 0 8px;
      font-size: 14px;
      font-weight: 1000;
      letter-spacing:.2px;
      display:flex; align-items:center; gap: 8px;
    }
    .muted{ color: var(--muted); font-size: 12px; }
    .muted2{ color: var(--muted2); font-size: 12px; }

    /* profile */
    .profile{
      display:grid;
      grid-template-columns: 124px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 520px){ .profile{ grid-template-columns: 104px 1fr; } }
    .photo{
      width: 124px; height: 124px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(110px 90px at 30% 25%, rgba(255,106,162,.22), transparent 60%),
        radial-gradient(110px 90px at 70% 35%, rgba(83,183,255,.18), transparent 60%),
        rgba(255,255,255,.06);
      overflow:hidden;
      display:grid; place-items:center;
    }
    @media (max-width: 520px){ .photo{ width:104px; height:104px; border-radius: 20px; } }
    .photo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .ph{
      font-size: 11px;
      font-weight: 1000;
      color: rgba(234,240,255,.70);
      text-align:center;
      padding: 10px;
      line-height: 1.2;
    }
    .nameLine{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .name{ font-size: 18px; font-weight: 1000; letter-spacing:.2px; }
    .badge{
      font-size: 11px;
      font-weight: 1000;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.86);
    }
    .badgeMint{ border-color: rgba(53,214,167,.35); background: rgba(53,214,167,.10); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    @media (max-width: 520px){ .grid2{ grid-template-columns: 1fr; } }
    .field{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 10px 12px;
      min-height: 46px;
    }
    .field b{ display:block; font-size: 11px; color: var(--muted2); margin-bottom: 2px; }
    .field span{ display:block; font-size: 13px; font-weight: 900; color: rgba(234,240,255,.92); }

    .sep{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .chips{ display:flex; flex-wrap: wrap; gap: 8px; }
    .chip{
      font-size: 11px; font-weight: 1000;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.86);
    }

    /* family viewer */
    .viewerTop{
      display:flex; gap: 10px; align-items:center; justify-content:space-between; flex-wrap: wrap;
    }
    .seg{
      display:flex;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      overflow:hidden;
    }
    .seg button{
      min-height: 38px;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: rgba(234,240,255,.78);
      font-weight: 1000;
      cursor: pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.08);
      color: rgba(234,240,255,.96);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    }
    .rangeRow{ display:flex; align-items:center; gap: 10px; }
    input[type="range"]{ width: 200px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: rgba(234,240,255,.80);
      font-weight: 1000;
    }

    .canvas{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      overflow:auto;
      padding: 10px;
    }

    /* tree (simple) */
    .tree{
      min-width: 740px;
      padding: 8px 6px 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      align-items:center;
    }
    .node{
      width: 100%;
      display:grid;
      grid-template-rows: auto auto;
      gap: 10px;
      align-items:center;
      justify-items:center;
    }
    .parents{
      width: 100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    .child{
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 8px;
    }
    .connector2{
      width: 90%;
      height: 18px;
      position: relative;
    }
    .connector2:before{
      content:"";
      position:absolute;
      left: 25%;
      right: 25%;
      top: 7px;
      height: 2px;
      background: rgba(255,255,255,.18);
      border-radius: 99px;
    }
    .connector2:after{
      content:"";
      position:absolute;
      left: 50%;
      top: 7px;
      width: 2px;
      height: 11px;
      background: rgba(255,255,255,.18);
      border-radius: 99px;
      transform: translateX(-50%);
    }

    .miniCard{
      width: 100%;
      max-width: 360px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(16,26,47,.78);
      border-radius: 20px;
      padding: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      cursor: pointer;
      user-select:none;
      transition: transform .05s ease;
    }
    .miniCard:active{ transform: scale(.995); }
    .miniCard:hover{ border-color: rgba(83,183,255,.28); }
    .miniCard.selected{
      border-color: rgba(255,106,162,.45);
      box-shadow: 0 0 0 3px rgba(255,106,162,.18);
    }
    .ava{
      width: 56px; height: 56px; border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
      display:grid; place-items:center;
    }
    .ava img{ width:100%; height:100%; object-fit:cover; display:block; }
    .ava .ph{ padding: 6px; font-size: 10px; }
    .mcMeta{ min-width:0; }
    .mcMeta b{ display:block; font-size: 13px; font-weight: 1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px; }
    .mcMeta span{ display:block; font-size: 11px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px; }

    /* descendants view (simple list by generation) */
    .gen{
      width: 100%;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 10px;
      margin-top: 10px;
    }
    .genTitle{
      display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap: wrap;
      font-size: 12px;
      color: rgba(234,240,255,.82);
      font-weight: 1000;
      margin-bottom: 8px;
    }
    .genTitle .count{ color: var(--muted2); font-weight: 900; }
    .genList{ display:flex; flex-wrap: wrap; gap: 10px; }

    /* carousels */
    .rail{
      display:flex;
      gap: 10px;
      overflow:auto;
      padding: 8px 2px 2px;
      scroll-snap-type: x mandatory;
    }
    .tile{
      flex: 0 0 auto;
      width: 180px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 10px;
      cursor:pointer;
      scroll-snap-align: start;
      user-select:none;
    }
    .tile:hover{ border-color: rgba(83,183,255,.28); }
    .tile:active{ transform: scale(.99); }
    .tileTop{ display:flex; gap: 10px; align-items:center; }
    .tileAva{
      width: 46px; height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .tileAva img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tileName{ font-weight: 1000; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tileSub{ font-size: 11px; color: var(--muted2); margin-top: 2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tinyHint{ font-size: 11px; color: var(--muted2); margin-top: 10px; }

    .toast{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(234,240,255,.82);
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .toast b{ color: rgba(234,240,255,.95); }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: rgba(234,240,255,.85);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸ°</div>
        <div class="brandText">
          <b>rabbit-roots</b>
          <span id="crumb">å€‹ä½“ãƒšãƒ¼ã‚¸ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—A / ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰</span>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btnGhost btnSky" id="btnRandom" title="ãƒ€ãƒŸãƒ¼ã®åˆ¥å€‹ä½“ã¸">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button class="btn btnMint" id="btnShare" title="ã“ã®ãƒšãƒ¼ã‚¸URLã‚’ã‚³ãƒ”ãƒ¼">ğŸ”— å…±æœ‰</button>
      </div>
    </div>

    <div class="row">
      <!-- LEFT: profile -->
      <section class="card">
        <div class="pad">
          <div class="h2">ğŸ‡ ã†ã•ããƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
          <div class="muted">å…¬é–‹ãƒšãƒ¼ã‚¸ã®ä¸»å½¹ã€‚ã“ã“ãŒã€Œã‹ã‚ã„ã„ã€ã¨ã€å…¨éƒ¨ãŒå¼·ããªã‚‹ã€‚</div>

          <div class="sep"></div>

          <div class="profile">
            <div class="photo" id="photo"></div>

            <div>
              <div class="nameLine">
                <div class="name" id="name">â€”</div>
                <span class="badge badgeMint" id="badgeConfirmed" style="display:none;">è¡€ç¸ãƒªãƒ³ã‚¯ï¼šç¢ºå®š</span>
                <span class="badge" id="badgeOrigin">â€”</span>
              </div>
              <div class="muted2" id="subtitle">â€”</div>

              <div class="grid2">
                <div class="field">
                  <b>èª•ç”Ÿæ—¥</b>
                  <span id="birth">â€”</span>
                </div>
                <div class="field">
                  <b>å‡ºè‡ª</b>
                  <span id="source">â€”</span>
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <b>å¥½ããªé£Ÿã¹ç‰©</b>
                  <span id="favFood">â€”</span>
                </div>
                <div class="field">
                  <b>å¥½ããªã“ã¨</b>
                  <span id="favThing">â€”</span>
                </div>
              </div>

              <div class="sep"></div>

              <div class="muted2" style="font-weight:900; margin-bottom:6px;">ãƒ¡ãƒ¢</div>
              <div class="toast" id="notes">â€”</div>

              <div class="sep"></div>
              <div class="chips" id="tags"></div>

              <div class="tinyHint">
                æ“ä½œï¼šã‚«ãƒ¼ãƒ‰ã‚’æŠ¼ã™ã¨å€‹ä½“ç§»å‹•ã€‚URLæœ«å°¾ã® <span class="kbd">#r_...</span> ã§ã‚‚ç§»å‹•ã§ãã¾ã™ã€‚
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: family viewer -->
      <section class="card">
        <div class="pad">
          <div class="h2">ğŸŒ¿ å®¶ç³»ãƒ“ãƒ¥ãƒ¼</div>
          <div class="muted">ç¥–å…ˆï¼ˆè¦ªæ–¹å‘ï¼‰/ å­å­«ï¼ˆå­æ–¹å‘ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€åºƒãŒã‚Šã‚’è¦‹ã‚‹ã€‚</div>

          <div class="sep"></div>

          <div class="viewerTop">
            <div class="seg" role="tablist" aria-label="family mode">
              <button id="tabAnc" class="active" role="tab" aria-selected="true">ç¥–å…ˆ</button>
              <button id="tabDes" role="tab" aria-selected="false">å­å­«</button>
            </div>

            <div class="rangeRow">
              <span class="pill">ä¸–ä»£ï¼š<b id="depthLabel">5</b></span>
              <input id="depthRange" type="range" min="1" max="8" step="1" value="4" />
            </div>
          </div>

          <div class="canvas" id="canvas">
            <!-- tree content -->
          </div>

          <div class="tinyHint" id="perfHint"></div>
        </div>
      </section>
    </div>

    <!-- Bottom: connections -->
    <section class="card" style="margin-top:12px;">
      <div class="pad">
        <div class="h2">ğŸ§µ ã¤ãªãŒã‚Š</div>
        <div class="muted">ãã‚‡ã†ã ã„ãƒ»å­ã©ã‚‚ã‚’æ¨ªã«ã‚ãã‚‹ã€‚ã“ã“ãŒâ€œå›³é‘‘ã®æ¥½ã—ã•â€ã€‚</div>

        <div class="sep"></div>

        <div class="h2" style="font-size:13px; margin-bottom:6px;">ãã‚‡ã†ã ã„ï¼ˆåŒè…¹ï¼‰</div>
        <div class="rail" id="railSiblings"></div>
        <div class="muted2" id="siblingsEmpty" style="display:none; margin-top:8px;">åŒè…¹ã®ãã‚‡ã†ã ã„ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>

        <div class="sep"></div>

        <div class="h2" style="font-size:13px; margin-bottom:6px;">å­ã©ã‚‚</div>
        <div class="rail" id="railChildren"></div>
        <div class="muted2" id="childrenEmpty" style="display:none; margin-top:8px;">å­ã©ã‚‚ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæœªæ¥æ ï¼‰ã€‚</div>

        <div class="sep"></div>

        <div class="toast">
          <b>ç›¸äº’åŒæ„ï¼ˆã‚³ãƒ¼ãƒ‰äº¤æ›ï¼‰</b>ã¯ Phase 2 ã§å®Ÿè£…äºˆå®šã€‚Phase 1 ã§ã¯è¦‹ãˆæ–¹ã ã‘ã‚’å…ˆã«å›ºã‚ã¾ã™ã€‚
        </div>
      </div>
    </section>
  </div>

<script>
'use strict';

/**
 * Phase1-A: Dummy dataset (fixed)
 * - Each rabbit has unique id
 * - Parents: fatherId / motherId
 * - Children are derived by reverse lookup (father/mother)
 * - "confirmedLink" is just a visual hint for prototype
 */
const DB = {
  rabbits: [
    // grandparents
    {id:"r_haru", name:"ã¯ã‚‹", birth:"2019-03-10", photo:null, origin:"ä¿è­·å›£ä½“", source:"é‡Œè¦ªå‹Ÿé›†", favFood:"ã‚Šã‚“ã”", favThing:"ã²ãªãŸã¼ã£ã“", notes:"é™ã‹ãªå­ã€‚æ’«ã§ã‚‹ã¨ç›®ãŒã¨ã‚ã‘ã‚‹ã€‚", tags:["#ãŠã£ã¨ã‚Š","#é•·ç”Ÿã"], fatherId:"", motherId:"", confirmedLink:true},
    {id:"r_sora", name:"ãã‚‰", birth:"2019-05-22", photo:null, origin:"ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼", source:"å‡ºèº«ä¸æ˜ï¼ˆè¨˜éŒ²å°‘ï¼‰", favFood:"ãƒãƒ¢ã‚·ãƒ¼", favThing:"æ®µå·®ã‚¸ãƒ£ãƒ³ãƒ—", notes:"ã‚±ãƒ¼ã‚¸ã®æ‰‰ãŒé–‹ãéŸ³ã«åå¿œã—ã¦é£›ã‚“ã§ãã‚‹ã€‚", tags:["#å…ƒæ°—","#æ¢ç´¢"], fatherId:"", motherId:"", confirmedLink:true},

    // parents generation
    {id:"r_shiratama", name:"ã—ã‚‰ãŸã¾", birth:"2021-02-14", photo:null, origin:"ä¿è­·å›£ä½“", source:"é‡Œè¦ªå‹Ÿé›†", favFood:"å°æ¾èœ", favThing:"é¼»ãƒ„ãƒ³", notes:"æœ€åˆã¯æ…é‡ã€‚ã§ã‚‚æ…£ã‚Œã‚‹ã¨ç”˜ãˆã‚“åŠã€‚", tags:["#ä¿è­·å›£ä½“","#ç”˜ãˆã‚“åŠ"], fatherId:"r_sora", motherId:"r_haru", confirmedLink:true},
    {id:"r_komugi", name:"ã“ã‚€ã", birth:"2021-06-01", photo:null, origin:"ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼", source:"é‡Œè¦ªå‹Ÿé›†", favFood:"ãƒšãƒ¬ãƒƒãƒˆ", favThing:"ç®±ã«å…¥ã‚‹", notes:"ç®±ã‚’è¦‹ã¤ã‘ã‚‹ã¨å¿…ãšå…¥ã‚‹ã€‚ã‚µã‚¤ã‚ºé–¢ä¿‚ãªã—ã€‚", tags:["#ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼","#ç®±å¥½ã"], fatherId:"", motherId:"", confirmedLink:true},

    // main litter (same parents)
    {id:"r_mochi", name:"ã‚‚ã¡", birth:"2023-01-20", photo:null, origin:"é‡Œè¦ª", source:"ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼â†’é‡Œè¦ªå‹Ÿé›†", favFood:"ãƒãƒ¢ã‚·ãƒ¼", favThing:"ãªã§ã‚‰ã‚Œã‚‹", notes:"å‘¼ã¶ã¨æ¥ã‚‹ã‚¿ã‚¤ãƒ—ã€‚å¤œã«å…ƒæ°—ã§èµ°ã‚Šå›ã‚‹ã€‚", tags:["#ä¸»å½¹","#ãªã§OK","#å¤œå‹"], fatherId:"r_komugi", motherId:"r_shiratama", confirmedLink:true},
    {id:"r_mimi", name:"ãƒŸãƒŸ", birth:"2023-01-20", photo:null, origin:"é‡Œè¦ª", source:"ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼â†’é‡Œè¦ªå‹Ÿé›†", favFood:"ã«ã‚“ã˜ã‚“è‘‰", favThing:"ã‚«ãƒ¼ãƒ†ãƒ³ã®è£", notes:"éš ã‚Œå®¶æ‹…å½“ã€‚é™ã‹ã«è¦—ãã¨ç›®ãŒåˆã†ã€‚", tags:["#åŒè…¹","#ã‹ãã‚Œã‚“ã¼"], fatherId:"r_komugi", motherId:"r_shiratama", confirmedLink:true},
    {id:"r_daifuku", name:"ã ã„ãµã", birth:"2023-01-20", photo:null, origin:"é‡Œè¦ª", source:"ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼â†’é‡Œè¦ªå‹Ÿé›†", favFood:"ã‚ªãƒ¼ãƒ„ãƒ˜ã‚¤", favThing:"ãƒ€ãƒƒã‚·ãƒ¥", notes:"èµ°ã‚Šå‡ºã™ã¨æ­¢ã¾ã‚‰ãªã„ã€‚æ›²ãŒã‚‹ã®ãŒã†ã¾ã„ã€‚", tags:["#åŒè…¹","#çˆ†èµ°"], fatherId:"r_komugi", motherId:"r_shiratama", confirmedLink:true},

    // next generation (children of mochi later)
    {id:"r_kohaku", name:"ã“ã¯ã", birth:"2025-04-08", photo:null, origin:"è¨˜éŒ²", source:"ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç”¨ï¼šã‚‚ã¡ã®å­ï¼‰", favFood:"ãƒãƒŠãƒŠå°‘ã—", favThing:"æ‰‹ã‚’ãªã‚ã‚‹", notes:"æ‰‹ã‚’å·®ã—å‡ºã™ã¨ãºã‚ã£ã¨ç¢ºèªã—ã¦ãã‚‹ã€‚", tags:["#å­ä¸–ä»£","#å¥½å¥‡å¿ƒ"], fatherId:"", motherId:"r_mochi", confirmedLink:true},
    {id:"r_yuzu", name:"ã‚†ãš", birth:"2025-04-08", photo:null, origin:"è¨˜éŒ²", source:"ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç”¨ï¼šã‚‚ã¡ã®å­ï¼‰", favFood:"ã‚Šã‚“ã”å°‘ã—", favThing:"ã“ã‚ã‚“", notes:"å®‰å¿ƒã™ã‚‹ã¨æ¨ªã«ã“ã‚ã‚“ã¨è»¢ãŒã‚‹ã€‚", tags:["#å­ä¸–ä»£","#ã“ã‚ã‚“"], fatherId:"", motherId:"r_mochi", confirmedLink:true},
  ]
};

function byId(id){ return DB.rabbits.find(r=>r.id===id) || null; }
function displayName(r){ return (r?.name || "ï¼ˆåå‰ãªã—ï¼‰").trim() || "ï¼ˆåå‰ãªã—ï¼‰"; }
function birthText(r){ return r?.birth ? r.birth : "â€”"; }

function getChildrenOf(parentId){
  return DB.rabbits.filter(r => r.fatherId === parentId || r.motherId === parentId);
}
function getSiblingsOf(r){
  if(!r || !r.fatherId || !r.motherId) return [];
  return DB.rabbits.filter(x =>
    x.id !== r.id &&
    x.fatherId === r.fatherId &&
    x.motherId === r.motherId
  );
}

function setHash(id){
  location.hash = id ? `#${id}` : "";
}

function getCurrentId(){
  const h = (location.hash || "").replace("#","");
  if(h && byId(h)) return h;
  return "r_mochi";
}

/* UI elements */
const el = {
  crumb: document.getElementById('crumb'),
  photo: document.getElementById('photo'),
  name: document.getElementById('name'),
  badgeConfirmed: document.getElementById('badgeConfirmed'),
  badgeOrigin: document.getElementById('badgeOrigin'),
  subtitle: document.getElementById('subtitle'),
  birth: document.getElementById('birth'),
  source: document.getElementById('source'),
  favFood: document.getElementById('favFood'),
  favThing: document.getElementById('favThing'),
  notes: document.getElementById('notes'),
  tags: document.getElementById('tags'),

  tabAnc: document.getElementById('tabAnc'),
  tabDes: document.getElementById('tabDes'),
  depthRange: document.getElementById('depthRange'),
  depthLabel: document.getElementById('depthLabel'),
  canvas: document.getElementById('canvas'),
  perfHint: document.getElementById('perfHint'),

  railSiblings: document.getElementById('railSiblings'),
  railChildren: document.getElementById('railChildren'),
  siblingsEmpty: document.getElementById('siblingsEmpty'),
  childrenEmpty: document.getElementById('childrenEmpty'),

  btnShare: document.getElementById('btnShare'),
  btnRandom: document.getElementById('btnRandom'),
};

let mode = 'anc'; // 'anc' or 'des'

/* Share */
async function copyUrl(){
  const url = location.href;
  try{
    await navigator.clipboard.writeText(url);
    el.crumb.textContent = "URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ…";
    setTimeout(()=> el.crumb.textContent = "å€‹ä½“ãƒšãƒ¼ã‚¸ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—A / ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰", 1300);
  }catch(e){
    alert("ã‚³ãƒ”ãƒ¼ã§ããªã‹ã£ãŸã®ã§ã€URLã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚\n\n" + url);
  }
}

/* Random */
function goRandom(){
  const list = DB.rabbits.slice();
  const pick = list[Math.floor(Math.random() * list.length)];
  setHash(pick.id);
}

/* Render profile */
function renderProfile(r){
  el.name.textContent = displayName(r);
  el.birth.textContent = birthText(r);
  el.source.textContent = r.source || "â€”";
  el.favFood.textContent = r.favFood || "â€”";
  el.favThing.textContent = r.favThing || "â€”";
  el.notes.textContent = r.notes || "â€”";

  el.badgeOrigin.textContent = r.origin ? `å‡ºè‡ªï¼š${r.origin}` : "â€”";

  el.badgeConfirmed.style.display = r.confirmedLink ? "" : "none";

  const parents = [];
  const f = byId(r.fatherId);
  const m = byId(r.motherId);
  if(f) parents.push(`çˆ¶ï¼š${displayName(f)}`);
  if(m) parents.push(`æ¯ï¼š${displayName(m)}`);
  el.subtitle.textContent = parents.length ? parents.join(" / ") : "ï¼ˆè¦ªæƒ…å ±ãªã—ï¼‰";

  // photo placeholder
  el.photo.innerHTML = "";
  if(r.photo){
    const img = document.createElement('img');
    img.src = r.photo;
    img.alt = displayName(r);
    el.photo.appendChild(img);
  }else{
    const ph = document.createElement('div');
    ph.className = 'ph';
    ph.textContent = "å†™çœŸ\nï¼ˆPhase1ã¯ãƒ€ãƒŸãƒ¼ï¼‰";
    el.photo.appendChild(ph);
  }

  // tags
  el.tags.innerHTML = "";
  (r.tags || []).forEach(t=>{
    const c = document.createElement('div');
    c.className = 'chip';
    c.textContent = t;
    el.tags.appendChild(c);
  });
}

/* Tree card */
function miniCard(r, label){
  const card = document.createElement('div');
  card.className = 'miniCard' + (r.id === getCurrentId() ? ' selected' : '');
  card.addEventListener('click', ()=> setHash(r.id));

  const ava = document.createElement('div');
  ava.className = 'ava';
  if(r.photo){
    const img = document.createElement('img');
    img.src = r.photo;
    img.alt = displayName(r);
    ava.appendChild(img);
  }else{
    const ph = document.createElement('div');
    ph.className = 'ph';
    ph.textContent = "å†™çœŸãªã—";
    ava.appendChild(ph);
  }

  const meta = document.createElement('div');
  meta.className = 'mcMeta';
  const b = document.createElement('b');
  b.textContent = displayName(r);
  const s = document.createElement('span');
  s.textContent = label || (r.birth ? `èª•ç”Ÿæ—¥ï¼š${r.birth}` : "â€”");
  meta.appendChild(b);
  meta.appendChild(s);

  card.appendChild(ava);
  card.appendChild(meta);
  return card;
}

function renderAncestorTree(rootId, depth){
  // depth = number of parent steps (0 means only self)
  const root = byId(rootId);
  if(!root){
    el.canvas.innerHTML = '<div class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }

  function nodeWrap(nodeId, d, visited){
    const n = byId(nodeId);
    const wrap = document.createElement('div');
    wrap.className = 'node';

    if(!n){
      const child = document.createElement('div');
      child.className = 'child';
      const dummy = {id:'_', name:'ï¼ˆä¸æ˜ï¼‰', birth:'', photo:null};
      child.appendChild(miniCard(dummy, 'ä¸æ˜'));
      wrap.appendChild(child);
      return wrap;
    }

    if(visited.has(nodeId)){
      const child = document.createElement('div');
      child.className = 'child';
      wrap.appendChild(child);
      child.appendChild(miniCard(n, 'ï¼ˆå¾ªç’°ï¼‰'));
      return wrap;
    }
    const v2 = new Set(visited);
    v2.add(nodeId);

    if(d > 0){
      const parents = document.createElement('div');
      parents.className = 'parents';
      parents.appendChild(nodeWrap(n.fatherId, d-1, v2));
      parents.appendChild(nodeWrap(n.motherId, d-1, v2));
      wrap.appendChild(parents);

      const conn = document.createElement('div');
      conn.className = 'connector2';
      wrap.appendChild(conn);
    }

    const child = document.createElement('div');
    child.className = 'child';
    child.appendChild(miniCard(n, nodeId === rootId ? 'æœ¬äºº' : (d===0 ? 'ç¥–å…ˆ' : 'â€”')));
    wrap.appendChild(child);

    return wrap;
  }

  const container = document.createElement('div');
  container.className = 'tree';
  container.appendChild(nodeWrap(rootId, depth, new Set()));
  el.canvas.innerHTML = '';
  el.canvas.appendChild(container);
}

function renderDescendants(rootId, depth){
  const root = byId(rootId);
  if(!root){
    el.canvas.innerHTML = '<div class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }

  // BFS by generation
  const gens = [];
  let current = [rootId];
  const visited = new Set([rootId]);

  for(let i=0; i<=depth; i++){
    const ids = current.filter(Boolean);
    gens.push(ids);
    const next = [];
    ids.forEach(id=>{
      const kids = getChildrenOf(id);
      kids.forEach(k=>{
        if(!visited.has(k.id)){
          visited.add(k.id);
          next.push(k.id);
        }
      });
    });
    current = next;
    if(current.length === 0) break;
  }

  const frag = document.createDocumentFragment();

  gens.forEach((ids, idx)=>{
    const box = document.createElement('div');
    box.className = 'gen';

    const title = document.createElement('div');
    title.className = 'genTitle';
    const left = document.createElement('div');
    left.textContent = idx === 0 ? 'ç¬¬0ä¸–ä»£ï¼ˆæœ¬äººï¼‰' : `ç¬¬${idx}ä¸–ä»£ï¼ˆå­å­«ï¼‰`;
    const right = document.createElement('div');
    right.className = 'count';
    right.textContent = `${ids.length}åŒ¹`;
    title.appendChild(left);
    title.appendChild(right);

    const list = document.createElement('div');
    list.className = 'genList';

    ids.forEach(id=>{
      const r = byId(id);
      if(!r) return;
      const card = document.createElement('div');
      card.style.flex = "0 0 auto";
      card.appendChild(miniCard(r, r.birth ? `èª•ç”Ÿæ—¥ï¼š${r.birth}` : "â€”"));
      list.appendChild(card.firstChild); // miniCard itself
    });

    box.appendChild(title);
    box.appendChild(list);
    frag.appendChild(box);
  });

  el.canvas.innerHTML = '';
  el.canvas.appendChild(frag);
}

/* Rail tiles */
function tile(r, subtitle){
  const t = document.createElement('div');
  t.className = 'tile';
  t.addEventListener('click', ()=> setHash(r.id));

  const top = document.createElement('div');
  top.className = 'tileTop';

  const a = document.createElement('div');
  a.className = 'tileAva';
  if(r.photo){
    const img = document.createElement('img');
    img.src = r.photo;
    img.alt = displayName(r);
    a.appendChild(img);
  }else{
    const ph = document.createElement('div');
    ph.className = 'ph';
    ph.textContent = "å†™çœŸ";
    a.appendChild(ph);
  }

  const meta = document.createElement('div');
  meta.style.minWidth = "0";
  const nm = document.createElement('div');
  nm.className = 'tileName';
  nm.textContent = displayName(r);
  const sub = document.createElement('div');
  sub.className = 'tileSub';
  sub.textContent = subtitle || (r.birth ? `èª•ç”Ÿæ—¥ï¼š${r.birth}` : 'â€”');
  meta.appendChild(nm);
  meta.appendChild(sub);

  top.appendChild(a);
  top.appendChild(meta);
  t.appendChild(top);

  return t;
}

function renderConnections(r){
  // siblings
  const sibs = getSiblingsOf(r);
  el.railSiblings.innerHTML = '';
  if(sibs.length === 0){
    el.siblingsEmpty.style.display = '';
  }else{
    el.siblingsEmpty.style.display = 'none';
    sibs.forEach(s=>{
      el.railSiblings.appendChild(tile(s, 'åŒè…¹'));
    });
  }

  // children
  const kids = getChildrenOf(r.id);
  el.railChildren.innerHTML = '';
  if(kids.length === 0){
    el.childrenEmpty.style.display = '';
  }else{
    el.childrenEmpty.style.display = 'none';
    kids.forEach(k=>{
      el.railChildren.appendChild(tile(k, 'å­'));
    });
  }
}

function renderAll(){
  const id = getCurrentId();
  const r = byId(id);
  if(!r) return;

  renderProfile(r);
  renderConnections(r);

  const depth = Number(el.depthRange.value || 4);
  el.depthLabel.textContent = String(depth + 1);

  // perf hint
  el.perfHint.textContent =
    depth >= 7
      ? "â€» æ·±ã„ä¸–ä»£ã¯é‡ããªã‚ŠãŒã¡ï¼ˆPhase1ã®ç›®å®‰ï¼š4ã€œ6ä¸–ä»£ï¼‰"
      : "";

  if(mode === 'anc'){
    renderAncestorTree(id, depth);
    el.tabAnc.classList.add('active');
    el.tabDes.classList.remove('active');
    el.tabAnc.setAttribute('aria-selected','true');
    el.tabDes.setAttribute('aria-selected','false');
  }else{
    renderDescendants(id, depth);
    el.tabDes.classList.add('active');
    el.tabAnc.classList.remove('active');
    el.tabDes.setAttribute('aria-selected','true');
    el.tabAnc.setAttribute('aria-selected','false');
  }
}

/* Events */
el.tabAnc.addEventListener('click', ()=>{ mode='anc'; renderAll(); });
el.tabDes.addEventListener('click', ()=>{ mode='des'; renderAll(); });
el.depthRange.addEventListener('input', renderAll);

el.btnShare.addEventListener('click', copyUrl);
el.btnRandom.addEventListener('click', goRandom);

window.addEventListener('hashchange', renderAll);

/* Init */
renderAll();
</script>
</body>
</html>
